# æ–‡ä»¶ä¸Šä¼ è·¯å¾„é—®é¢˜ç´§æ€¥ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜ç°çŠ¶

æ ¹æ®æœ€æ–°çš„æœåŠ¡å™¨æ—¥å¿—åˆ†æï¼Œå‘ç°äº†ä¸¥é‡é—®é¢˜ï¼š

### âŒ å…³é”®é—®é¢˜
- **æ–°åˆ›å»ºçš„æ–‡ä»¶ä¹Ÿæ‰¾ä¸åˆ°**ï¼šè¯´æ˜æ–‡ä»¶ä¸Šä¼ è·¯å¾„é…ç½®æœ‰æ ¹æœ¬æ€§é—®é¢˜
- **é¢„æœŸè·¯å¾„**ï¼š`/uploads/images/6881abd9273b0f9323dab098/media-1753428229536-413926255.jpg`
- **å®é™…çŠ¶æ€**ï¼šæ–‡ä»¶ä¸å­˜åœ¨äºé¢„æœŸä½ç½®

### ğŸ“Š ä¿®å¤è„šæœ¬æ‰§è¡Œç»“æœ
```
æ‰¾åˆ° 19 ä¸ªåŒ…å«åª’ä½“æ–‡ä»¶çš„å¸–å­
âŒ æ–°æ ¼å¼æ–‡ä»¶ä¸å­˜åœ¨: /uploads/images/6881abd9273b0f9323dab098/media-1753428229536-413926255.jpg
âŒ æ–°æ ¼å¼æ–‡ä»¶ä¸å­˜åœ¨: /uploads/images/6881abd9273b0f9323dab098/media-1753430022722-517899134.jpg
âœ… æˆåŠŸä¿®å¤çš„å¸–å­æ•°é‡: 0
âŒ å‡ºç°é”™è¯¯çš„æ–‡ä»¶æ•°é‡: 2
```

## ğŸ” é—®é¢˜åˆ†æ

### å¯èƒ½çš„åŸå› 

1. **æ–‡ä»¶å®é™…ä¸Šä¼ ä½ç½®é”™è¯¯**
   - æ–‡ä»¶å¯èƒ½ä¸Šä¼ åˆ°äº†å…¶ä»–ç›®å½•
   - é…ç½®ä¸­çš„ä¸Šä¼ è·¯å¾„ä¸å®é™…ä¸ç¬¦

2. **è·¯å¾„é…ç½®é—®é¢˜**
   - `config.upload.path` é…ç½®é”™è¯¯
   - ç¯å¢ƒå˜é‡ `UPLOAD_PATH` è®¾ç½®ä¸æ­£ç¡®

3. **æ–‡ä»¶æƒé™é—®é¢˜**
   - ç›®å½•åˆ›å»ºå¤±è´¥
   - æ–‡ä»¶å†™å…¥æƒé™ä¸è¶³

4. **ç›¸å¯¹è·¯å¾„vsç»å¯¹è·¯å¾„é—®é¢˜**
   - ä»£ç ä¸­ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„ä½†å·¥ä½œç›®å½•ä¸æ­£ç¡®

## ğŸš€ ç«‹å³è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æœåŠ¡å™¨æ–‡ä»¶ç»“æ„

**Windowsç”¨æˆ·**ï¼š
```bash
check-server-file-structure.bat
```

**Linux/Macç”¨æˆ·**ï¼š
```bash
chmod +x check-server-file-structure.sh
./check-server-file-structure.sh
```

### æ­¥éª¤2ï¼šæ‰‹åŠ¨æ£€æŸ¥å…³é”®ä¿¡æ¯

è¿æ¥åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œï¼š

```bash
ssh root@your-server-ip
cd /var/www/mj-gallery

# 1. æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•
pwd

# 2. æ£€æŸ¥uploadsç›®å½•ç»“æ„
ls -la uploads/
ls -la uploads/images/

# 3. æŸ¥æ‰¾æœ€æ–°ä¸Šä¼ çš„æ–‡ä»¶
find . -name "media-*" -type f -mtime -1

# 4. æ£€æŸ¥é…ç½®æ–‡ä»¶
cat server/config/index.js | grep -A 10 upload

# 5. æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $UPLOAD_PATH
cat .env | grep UPLOAD
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿®å¤ä¸Šä¼ è·¯å¾„é…ç½®

#### 1. æ£€æŸ¥å¹¶ä¿®æ­£configé…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano /var/www/mj-gallery/server/config/index.js

# ç¡®ä¿upload.pathé…ç½®æ­£ç¡®
# åº”è¯¥æ˜¯ç»å¯¹è·¯å¾„ï¼š/var/www/mj-gallery/uploads
# æˆ–ç›¸å¯¹è·¯å¾„ï¼šuploadsï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰
```

#### 2. ä¿®æ­£posts.jsä¸­çš„è·¯å¾„å¤„ç†

æ£€æŸ¥ `/var/www/mj-gallery/server/routes/posts.js` ç¬¬76è¡Œé™„è¿‘ï¼š

```javascript
// ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ‹¼æ¥
const userId = req.userId.toString();
let uploadPath;

if (file.mimetype.startsWith('image/')) {
  // ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç¡®ä¿ç›¸å¯¹è·¯å¾„æ­£ç¡®
  uploadPath = path.join(process.cwd(), config.upload.path, 'images', userId);
} else if (file.mimetype.startsWith('video/')) {
  uploadPath = path.join(process.cwd(), config.upload.path, 'videos', userId);
} else {
  uploadPath = path.join(process.cwd(), config.upload.path, userId);
}
```

### æ–¹æ¡ˆäºŒï¼šåˆ›å»ºä¸´æ—¶ä¿®å¤è„šæœ¬

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸´æ—¶è¯Šæ–­è„šæœ¬ï¼š

```bash
cat > /var/www/mj-gallery/diagnose-upload.js << 'EOF'
const path = require('path');
const fs = require('fs');
const config = require('./server/config');

console.log('=== ä¸Šä¼ è·¯å¾„è¯Šæ–­ ===');
console.log('å½“å‰å·¥ä½œç›®å½•:', process.cwd());
console.log('é…ç½®çš„ä¸Šä¼ è·¯å¾„:', config.upload.path);
console.log('ç»å¯¹ä¸Šä¼ è·¯å¾„:', path.resolve(config.upload.path));

// æµ‹è¯•è·¯å¾„åˆ›å»º
const testUserId = '6881abd9273b0f9323dab098';
const testPath = path.join(config.upload.path, 'images', testUserId);
const absoluteTestPath = path.resolve(testPath);

console.log('æµ‹è¯•ç”¨æˆ·è·¯å¾„:', testPath);
console.log('ç»å¯¹æµ‹è¯•è·¯å¾„:', absoluteTestPath);
console.log('è·¯å¾„æ˜¯å¦å­˜åœ¨:', fs.existsSync(absoluteTestPath));

// å°è¯•åˆ›å»ºç›®å½•
try {
  if (!fs.existsSync(absoluteTestPath)) {
    fs.mkdirSync(absoluteTestPath, { recursive: true });
    console.log('âœ… æˆåŠŸåˆ›å»ºæµ‹è¯•ç›®å½•');
  } else {
    console.log('âœ… æµ‹è¯•ç›®å½•å·²å­˜åœ¨');
  }
} catch (error) {
  console.log('âŒ åˆ›å»ºç›®å½•å¤±è´¥:', error.message);
}

// æ£€æŸ¥ç°æœ‰æ–‡ä»¶
console.log('\n=== æŸ¥æ‰¾ç°æœ‰mediaæ–‡ä»¶ ===');
const findFiles = (dir) => {
  try {
    const files = fs.readdirSync(dir, { withFileTypes: true });
    files.forEach(file => {
      const fullPath = path.join(dir, file.name);
      if (file.isDirectory()) {
        findFiles(fullPath);
      } else if (file.name.startsWith('media-')) {
        console.log('æ‰¾åˆ°æ–‡ä»¶:', fullPath);
      }
    });
  } catch (error) {
    // å¿½ç•¥é”™è¯¯
  }
};

findFiles('.');
EOF

# è¿è¡Œè¯Šæ–­è„šæœ¬
node diagnose-upload.js
```

### æ–¹æ¡ˆä¸‰ï¼šé‡æ–°é…ç½®ä¸Šä¼ è·¯å¾„

å¦‚æœå‘ç°é…ç½®é—®é¢˜ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano /var/www/mj-gallery/server/config/index.js

# ä¿®æ”¹uploadé…ç½®ä¸ºç»å¯¹è·¯å¾„
upload: {
  path: '/var/www/mj-gallery/uploads',
  // å…¶ä»–é…ç½®...
}

# æˆ–è€…ç¡®ä¿ç›¸å¯¹è·¯å¾„æ­£ç¡®
upload: {
  path: 'uploads',  // ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
  // å…¶ä»–é…ç½®...
}
```

## ğŸ¯ éªŒè¯ä¿®å¤

### 1. é‡å¯æœåŠ¡
```bash
pm2 restart mj-gallery-server
pm2 logs mj-gallery-server --lines 20
```

### 2. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
- ç™»å½•ç½‘ç«™
- åˆ›å»ºæ–°å¸–å­å¹¶ä¸Šä¼ å›¾ç‰‡
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å‡ºç°åœ¨æ­£ç¡®ä½ç½®

### 3. æ£€æŸ¥æ•°æ®åº“è®°å½•
```bash
mongo midjourney-gallery
db.posts.findOne({}, {media: 1}).media
```

## ğŸš¨ ç´§æ€¥æ¢å¤æ–¹æ¡ˆ

å¦‚æœé—®é¢˜ä¸¥é‡ï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹posts.jsä½¿ç”¨å›ºå®šè·¯å¾„ï¼š

```javascript
// ä¸´æ—¶ä¿®å¤ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„
destination: (req, file, cb) => {
  const userId = req.userId.toString();
  const uploadPath = `/var/www/mj-gallery/uploads/images/${userId}`;
  
  // ç¡®ä¿ç›®å½•å­˜åœ¨
  if (!fs.existsSync(uploadPath)) {
    fs.mkdirSync(uploadPath, { recursive: true });
  }
  
  cb(null, uploadPath);
},
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œæ–‡ä»¶ç»“æ„æ£€æŸ¥è„šæœ¬
- [ ] ç¡®è®¤uploadsç›®å½•å­˜åœ¨ä¸”æƒé™æ­£ç¡®
- [ ] æ£€æŸ¥config.upload.pathé…ç½®
- [ ] éªŒè¯posts.jsä¸­çš„è·¯å¾„æ‹¼æ¥é€»è¾‘
- [ ] æµ‹è¯•æ–°æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- [ ] é‡æ–°è¿è¡Œ404ä¿®å¤è„šæœ¬

---

**é‡è¦æé†’**ï¼šè¿™æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œå½±å“æ‰€æœ‰æ–°æ–‡ä»¶ä¸Šä¼ ã€‚è¯·ç«‹å³æ‰§è¡Œè¯Šæ–­æ­¥éª¤ï¼Œç¡®å®šæ ¹æœ¬åŸå› åå†è¿›è¡Œä¿®å¤ã€‚