# 服务器文件404修复指南

## 问题现状

✅ **ObjectId错误已修复**：可以正常创建帖子
❌ **历史文件404错误**：旧文件路径格式导致无法访问

### 错误示例
```
GET https://iii.pics/uploads/images/6881abd…/media-1753430022722-517899134.jpg 404 (Not Found)
GET https://iii.pics/uploads/images/6881abd…/media-1753428229536-413926255.jpg 404 (Not Found)
```

## 问题分析

### 1. 路径格式问题
- **旧格式**：`uploads/media-timestamp-random.jpg`
- **新格式**：`uploads/images/userId/media-timestamp-random.jpg`

### 2. 数据库记录不匹配
数据库中存储的文件路径与实际文件系统路径不一致。

## 修复方案

### 方案一：上传修复脚本到服务器（推荐）

#### 1. 上传修复脚本
```bash
# 上传文件404修复脚本
scp fix-file-404-issue.js root@your-server-ip:/var/www/mj-gallery/
```

#### 2. 在服务器上执行修复
```bash
# 连接到服务器
ssh root@your-server-ip

# 进入项目目录
cd /var/www/mj-gallery

# 运行修复脚本
node fix-file-404-issue.js
```

#### 3. 重启服务
```bash
# 重启PM2服务
pm2 restart mj-gallery-server

# 检查状态
pm2 status
pm2 logs mj-gallery-server --lines 20
```

### 方案二：手动数据库修复

如果无法上传脚本，可以直接在服务器上操作数据库：

```bash
# 连接到服务器
ssh root@your-server-ip

# 连接MongoDB
mongo midjourney-gallery

# 查看需要修复的帖子
db.posts.find({"media.url": {$regex: "^uploads/media-"}}).limit(5);

# 批量更新文件路径
db.posts.updateMany(
  {"media.url": {$regex: "^uploads/media-"}},
  {
    $set: {
      "media.$[elem].url": {
        $concat: [
          "uploads/images/",
          "$author",
          "/",
          {$substr: ["$media.url", 8, -1]}
        ]
      }
    }
  },
  {arrayFilters: [{"elem.url": {$regex: "^uploads/media-"}}]}
);
```

### 方案三：文件系统重组织

如果数据库修复复杂，可以重新组织文件系统：

```bash
# 连接到服务器
ssh root@your-server-ip
cd /var/www/mj-gallery

# 创建临时脚本
cat > reorganize-files.js << 'EOF'
const fs = require('fs');
const path = require('path');
const mongoose = require('mongoose');
const Post = require('./server/models/Post');

// 连接数据库
mongoose.connect('mongodb://localhost:27017/midjourney-gallery');

async function reorganizeFiles() {
  try {
    // 获取所有包含旧路径格式的帖子
    const posts = await Post.find({
      'media.url': { $regex: '^uploads/media-' }
    });

    console.log(`找到 ${posts.length} 个需要修复的帖子`);

    for (const post of posts) {
      const userId = post.author.toString();
      const userDir = path.join('uploads', 'images', userId);
      
      // 确保用户目录存在
      if (!fs.existsSync(userDir)) {
        fs.mkdirSync(userDir, { recursive: true });
      }

      // 处理每个媒体文件
      for (let i = 0; i < post.media.length; i++) {
        const media = post.media[i];
        if (media.url.startsWith('uploads/media-')) {
          const fileName = path.basename(media.url);
          const oldPath = media.url;
          const newPath = path.join('uploads', 'images', userId, fileName);
          
          // 移动文件（如果存在）
          if (fs.existsSync(oldPath)) {
            fs.renameSync(oldPath, newPath);
            console.log(`移动文件: ${oldPath} -> ${newPath}`);
          }
          
          // 更新数据库记录
          post.media[i].url = newPath;
        }
      }
      
      // 保存更新后的帖子
      await post.save();
      console.log(`更新帖子: ${post._id}`);
    }
    
    console.log('文件重组织完成！');
  } catch (error) {
    console.error('修复过程中出错:', error);
  } finally {
    mongoose.disconnect();
  }
}

reorganizeFiles();
EOF

# 运行重组织脚本
node reorganize-files.js

# 重启服务
pm2 restart mj-gallery-server
```

## 验证修复结果

### 1. 检查数据库
```bash
# 连接MongoDB
mongo midjourney-gallery

# 检查是否还有旧格式路径
db.posts.find({"media.url": {$regex: "^uploads/media-"}}).count();

# 应该返回 0
```

### 2. 检查文件系统
```bash
# 检查uploads目录结构
ls -la uploads/
ls -la uploads/images/

# 应该看到按用户ID组织的目录结构
```

### 3. 测试网站
- 刷新网站页面
- 检查图片是否正常显示
- 查看浏览器控制台是否还有404错误

## 预期结果

修复完成后：

✅ **历史帖子图片正常显示**
✅ **无404错误**
✅ **文件路径格式统一**
✅ **数据库记录与文件系统一致**

## 故障排除

### 如果修复脚本执行失败
1. 检查Node.js和MongoDB连接
2. 确认项目依赖已安装
3. 检查文件权限

### 如果仍有404错误
1. 检查nginx配置
2. 确认文件路径映射正确
3. 重启nginx服务

### 如果数据库更新失败
1. 备份数据库
2. 检查MongoDB版本兼容性
3. 手动执行单条更新测试

---

**重要提醒**：
- 执行修复前建议备份数据库和文件
- 修复过程中避免用户上传新文件
- 修复完成后测试所有功能