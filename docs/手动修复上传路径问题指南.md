# æ‰‹åŠ¨ä¿®å¤ä¸Šä¼ è·¯å¾„é—®é¢˜æŒ‡å—

## ğŸš¨ é—®é¢˜ç°çŠ¶

æ‰¹å¤„ç†æ–‡ä»¶å‡ºç°ç¼–ç é—®é¢˜ï¼Œå¯¼è‡´ä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºä¸ºä¹±ç ã€‚ä»¥ä¸‹æ˜¯æ‰‹åŠ¨ä¿®å¤æ­¥éª¤ã€‚

## ğŸ”§ æ‰‹åŠ¨ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@your-server-ip
```

### æ­¥éª¤2ï¼šè¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /var/www/mj-gallery
```

### æ­¥éª¤3ï¼šæ£€æŸ¥å½“å‰é…ç½®

```bash
# æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•
pwd

# æ£€æŸ¥uploadsç›®å½•
ls -la uploads/

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat .env | grep UPLOAD || echo "UPLOAD_PATH not found in .env"
```

### æ­¥éª¤4ï¼šåˆ›å»ºå¿…è¦çš„ç›®å½•

```bash
# åˆ›å»ºuploadsç›®å½•ç»“æ„
mkdir -p uploads/images
mkdir -p uploads/videos
mkdir -p uploads/thumbnails
mkdir -p uploads/temp

# è®¾ç½®æƒé™
chown -R www-data:www-data uploads/
chmod -R 755 uploads/
```

### æ­¥éª¤5ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# æ£€æŸ¥.envæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f .env ]; then
    echo "UPLOAD_PATH=/var/www/mj-gallery/uploads" > .env
    echo "Created .env file"
else
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰UPLOAD_PATH
    if ! grep -q "UPLOAD_PATH" .env; then
        echo "UPLOAD_PATH=/var/www/mj-gallery/uploads" >> .env
        echo "Added UPLOAD_PATH to .env"
    else
        echo "UPLOAD_PATH already exists in .env"
    fi
fi
```

### æ­¥éª¤6ï¼šéªŒè¯é…ç½®

```bash
# æµ‹è¯•é…ç½®åŠ è½½
node -e "const config = require('./server/config'); console.log('Upload path:', config.upload.path); const fs = require('fs'); console.log('Path exists:', fs.existsSync(config.upload.path));"
```

### æ­¥éª¤7ï¼šé‡å¯æœåŠ¡

```bash
# é‡å¯PM2æœåŠ¡
pm2 restart mj-gallery-server

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 list

# æŸ¥çœ‹æ—¥å¿—
pm2 logs mj-gallery-server --lines 20
```

### æ­¥éª¤8ï¼šæµ‹è¯•æ–‡ä»¶ä¸Šä¼ 

```bash
# åˆ›å»ºæµ‹è¯•ç›®å½•
test_user_id="test-$(date +%s)"
test_dir="uploads/images/$test_user_id"
mkdir -p "$test_dir"

# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
echo "test content" > "$test_dir/test-file.txt"

# éªŒè¯æ–‡ä»¶åˆ›å»º
if [ -f "$test_dir/test-file.txt" ]; then
    echo "SUCCESS: File creation test passed"
    rm -rf "$test_dir"
else
    echo "ERROR: File creation test failed"
fi
```

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœç›®å½•åˆ›å»ºå¤±è´¥

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥æƒé™
ls -la /var/www/

# æ‰‹åŠ¨åˆ›å»ºå¹¶è®¾ç½®æƒé™
sudo mkdir -p /var/www/mj-gallery/uploads
sudo chown -R $USER:$USER /var/www/mj-gallery/uploads
```

### å¦‚æœé…ç½®åŠ è½½å¤±è´¥

```bash
# æ£€æŸ¥configæ–‡ä»¶è¯­æ³•
node -c server/config/index.js

# æ£€æŸ¥ä¾èµ–
npm list dotenv

# é‡æ–°å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install
```

### å¦‚æœPM2é‡å¯å¤±è´¥

```bash
# åœæ­¢æ‰€æœ‰PM2è¿›ç¨‹
pm2 stop all

# åˆ é™¤PM2è¿›ç¨‹
pm2 delete all

# é‡æ–°å¯åŠ¨
npm run start:server
```

## ğŸ“‹ éªŒè¯æ¸…å•

å®Œæˆä¿®å¤åï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] `/var/www/mj-gallery/uploads/` ç›®å½•å­˜åœ¨
- [ ] `/var/www/mj-gallery/uploads/images/` ç›®å½•å­˜åœ¨
- [ ] `.env` æ–‡ä»¶åŒ…å« `UPLOAD_PATH=/var/www/mj-gallery/uploads`
- [ ] PM2æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] é…ç½®æ­£ç¡®åŠ è½½ï¼ˆé€šè¿‡nodeæµ‹è¯•å‘½ä»¤éªŒè¯ï¼‰
- [ ] å¯ä»¥åœ¨ç½‘ç«™ä¸Šåˆ›å»ºæ–°å¸–å­å¹¶ä¸Šä¼ å›¾ç‰‡
- [ ] ä¸Šä¼ çš„å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼š

1. **æ–°æ–‡ä»¶ä¸Šä¼ **ï¼šåº”è¯¥èƒ½å¤Ÿæ­£å¸¸ä¸Šä¼ å¹¶æ˜¾ç¤ºå›¾ç‰‡
2. **è·¯å¾„æ ¼å¼**ï¼šæ–°æ–‡ä»¶åº”è¯¥ä¿å­˜åœ¨ `/var/www/mj-gallery/uploads/images/ç”¨æˆ·ID/` ç›®å½•ä¸‹
3. **æ— é”™è¯¯æ—¥å¿—**ï¼šPM2æ—¥å¿—ä¸­ä¸åº”è¯¥å†å‡ºç° `TypeError [ERR_INVALID_ARG_TYPE]` é”™è¯¯
4. **å†å²æ–‡ä»¶**ï¼šéœ€è¦å•ç‹¬è¿è¡Œ404ä¿®å¤è„šæœ¬å¤„ç†

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# æ”¶é›†è¯Šæ–­ä¿¡æ¯
echo "=== System Info ===" > debug-info.txt
pwd >> debug-info.txt
echo "" >> debug-info.txt

echo "=== Directory Structure ===" >> debug-info.txt
ls -la uploads/ >> debug-info.txt 2>&1
echo "" >> debug-info.txt

echo "=== Environment Variables ===" >> debug-info.txt
cat .env >> debug-info.txt 2>&1
echo "" >> debug-info.txt

echo "=== PM2 Status ===" >> debug-info.txt
pm2 list >> debug-info.txt
echo "" >> debug-info.txt

echo "=== Recent Logs ===" >> debug-info.txt
pm2 logs mj-gallery-server --lines 20 >> debug-info.txt 2>&1

echo "Debug info saved to debug-info.txt"
cat debug-info.txt
```

å°†è¾“å‡ºç»“æœæä¾›ç»™æŠ€æœ¯æ”¯æŒã€‚