# 502错误远程服务器修复指南

## 问题确认

根据本地日志 `logs\err.log` 显示的错误信息，服务器端仍然存在环境变量加载问题：
```
2025-07-24 00:59:44: Error: 缺少必需的环境变量: JWT_SECRET, MONGODB_URI
```

## 远程服务器操作步骤

### 1. 连接服务器并检查当前状态

```bash
# 连接到服务器
ssh root@your-server-ip

# 进入项目目录
cd /var/www/mj-gallery

# 检查PM2状态
pm2 status

# 查看实时错误日志
pm2 logs mj-gallery-server --lines 50
```

### 2. 执行环境变量修复

```bash
# 进入服务器目录
cd /var/www/mj-gallery/server

# 运行修复脚本（如果存在）
node ../fix-pm2-env-config.js

# 或者手动修复ecosystem.config.js
```

### 3. 手动修复ecosystem.config.js（如果自动脚本失败）

编辑 `/var/www/mj-gallery/ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'mj-gallery-server',
    script: './server/index.js',
    cwd: '/var/www/mj-gallery',
    env: {
      NODE_ENV: 'production',
      PORT: '5500',
      MONGODB_URI: 'mongodb://localhost:27017/midjourney-gallery',
      JWT_SECRET: 'your-actual-jwt-secret-here',
      CLIENT_URL: 'https://iii.pics',
      MAX_FILE_SIZE: '50MB',
      UPLOAD_PATH: '/var/www/mj-gallery/server/uploads',
      EMAIL_ENABLED: 'true',
      SMTP_HOST: 'smtpdm.aliyun.com',
      SMTP_PORT: '465',
      SMTP_SECURE: 'true',
      SMTP_USER: 'i@mail.iii.pics',
      SMTP_PASS: 'your-smtp-password',
      EMAIL_FROM: 'i@mail.iii.pics'
    },
    error_file: '/var/www/mj-gallery/logs/err.log',
    out_file: '/var/www/mj-gallery/logs/out.log',
    log_file: '/var/www/mj-gallery/logs/combined.log',
    time: true
  }]
};
```

### 4. 重启服务

```bash
# 停止当前服务
pm2 stop mj-gallery-server

# 删除旧进程
pm2 delete mj-gallery-server

# 重新启动
pm2 start ecosystem.config.js

# 检查状态
pm2 status

# 查看日志确认启动成功
pm2 logs mj-gallery-server --lines 20
```

### 5. 验证修复结果

```bash
# 测试API端点
curl -I https://iii.pics/api/posts/featured

# 应该返回200状态码而不是502
```

## 如果问题仍然存在

### 检查.env文件

```bash
# 确认.env文件存在且包含所需变量
cat /var/www/mj-gallery/server/.env

# 确保文件权限正确
chmod 644 /var/www/mj-gallery/server/.env
```

### 检查MongoDB服务

```bash
# 检查MongoDB状态
systemctl status mongod

# 如果未运行，启动MongoDB
systemctl start mongod
systemctl enable mongod
```

### 检查端口占用

```bash
# 检查5500端口是否被占用
netstat -tlnp | grep 5500

# 如果被占用，杀死占用进程或更改端口
```

## 预防措施

1. **备份配置文件**：
   ```bash
   cp ecosystem.config.js ecosystem.config.js.backup
   cp server/.env server/.env.backup
   ```

2. **设置监控**：
   ```bash
   # 设置PM2监控
   pm2 monit
   ```

3. **定期检查日志**：
   ```bash
   # 设置日志轮转
   pm2 install pm2-logrotate
   ```

## 联系方式

如果需要远程协助，请提供：
- 服务器SSH访问信息
- 当前错误日志截图
- PM2状态截图

---

**注意**：请确保在执行任何操作前备份重要文件，避免数据丢失。