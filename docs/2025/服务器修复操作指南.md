# 服务器修复操作指南

## 问题分析

根据终端输出，您已成功连接到服务器，但在运行修复脚本时遇到了路径错误：

```
Error: Cannot find module '/root/fix-objectid-path-error.js'
```

**问题原因**：修复脚本文件不在当前目录（/root），需要先上传到正确位置。

## 解决方案

### 方法1：上传脚本到服务器（推荐）

#### 步骤1：退出SSH连接
```bash
exit  # 退出SSH连接
```

#### 步骤2：从本地上传脚本
```bash
# 在本地PowerShell中执行
scp fix-objectid-path-error.js root@167.253.157.83:/var/www/mj-gallery/
scp fix-file-404-issue.js root@167.253.157.83:/var/www/mj-gallery/
```

#### 步骤3：重新连接并进入项目目录
```bash
ssh root@167.253.157.83
cd /var/www/mj-gallery
ls -la *.js  # 确认文件已上传
```

#### 步骤4：运行修复脚本
```bash
# 修复ObjectId错误
node fix-objectid-path-error.js

# 重启服务
pm2 restart mj-gallery-server

# 检查状态
pm2 logs mj-gallery-server --lines 10
```

### 方法2：直接在服务器上创建脚本

如果上传失败，可以直接在服务器上创建脚本：

```bash
# 在SSH连接中执行
cd /var/www/mj-gallery

# 创建修复脚本
nano fix-objectid-path-error.js
```

然后复制本地脚本内容到服务器文件中。

### 方法3：手动修复（最快）

如果脚本上传有问题，可以直接手动修复：

```bash
# 在SSH连接中执行
cd /var/www/mj-gallery

# 备份原文件
cp server/routes/posts.js server/routes/posts.js.backup

# 编辑文件
nano server/routes/posts.js
```

在编辑器中找到包含 `path.join('uploads', req.user.id)` 的行，修改为：
```javascript
path.join('uploads', req.user.id.toString())
```

保存后重启服务：
```bash
pm2 restart mj-gallery-server
pm2 logs mj-gallery-server --lines 10
```

## 验证修复结果

### 检查服务状态
```bash
pm2 status
pm2 logs mj-gallery-server --lines 20
```

### 测试API端点
```bash
curl -I https://iii.pics/api/posts/featured
curl -I https://iii.pics/api/posts/tags/popular
```

### 测试文件上传
在前端尝试创建新帖子并上传图片，确认不再出现ObjectId错误。

## 预期结果

修复成功后应该看到：
- ✅ 服务器正常运行
- ✅ 不再出现ObjectId类型错误
- ✅ 文件上传功能正常
- ✅ API端点返回200状态码

## 如果仍有问题

1. 检查服务器上的项目路径是否正确
2. 确认PM2服务是否正常运行
3. 查看完整的错误日志

```bash
# 查看项目结构
ls -la /var/www/mj-gallery/

# 查看PM2状态
pm2 list

# 查看详细日志
pm2 logs mj-gallery-server --lines 50
```

---

**下一步**：请按照方法1的步骤操作，先上传脚本文件到服务器。