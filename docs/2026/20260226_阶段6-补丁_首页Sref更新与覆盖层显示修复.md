# é˜¶æ®µ6 è¡¥ä¸ â€” é¦–é¡µ Sref æ•°æ®æºæ›´æ–° & å¡ç‰‡è¦†ç›–å±‚åŠ è½½æ—¶æœºä¿®å¤

**æ—¥æœŸ**ï¼š2026-02-26
**åˆ†æ”¯**ï¼šmain
**æ¶‰åŠæ–‡ä»¶**ï¼š`Home.js` / `SrefCard.js` / `LiblibStyleCard.css` / `server/routes/sref.js`

---

## ä¸€ã€é—®é¢˜æè¿°

é˜¶æ®µ6å®Œæˆåå‘ç°ä¸‰ä¸ªé—ç•™é—®é¢˜ï¼š

### é—®é¢˜ 1 â€” é¦–é¡µæœªæ›´æ–°æ•°æ®æº

é¦–é¡µï¼ˆ`/`ï¼‰"Latest content"åŒºå—ä»åœ¨ä½¿ç”¨ `enhancedPostAPI`ï¼ˆç¤¾åŒºå¸–å­ï¼‰+ `promptAPI`ï¼ˆæç¤ºè¯ï¼‰åŒæ•°æ®æºï¼Œä¸ `/explore` çš„ sref æ•°æ®ä¸ä¸€è‡´ã€‚ç”¨æˆ·æœŸæœ›é¦–é¡µä¸ `/explore` å±•ç¤ºç›¸åŒçš„ sref é£æ ¼å¡ç‰‡ã€‚

### é—®é¢˜ 2 â€” Related Styles ç¼©ç•¥å›¾ä¸æ˜¾ç¤º

`/explore/:id` è¯¦æƒ…é¡µåº•éƒ¨"Related Styles"ç½‘æ ¼ä¸­ï¼Œæ‰€æœ‰å¡ç‰‡åªæ˜¾ç¤º ğŸ¨ å ä½ç¬¦ï¼Œä¸æ˜¾ç¤ºå›¾ç‰‡ã€‚

**æ ¹å› **ï¼š`server/routes/sref.js` è¯¦æƒ…æ¥å£æŸ¥è¯¢ related æ—¶ä½¿ç”¨äº† `.lean({ virtuals: true })`ï¼Œä½† mongoose `lean()` ä¸ä¿è¯è™šæ‹Ÿå­—æ®µç”Ÿæ•ˆï¼ˆå–å†³äº mongoose ç‰ˆæœ¬ï¼‰ï¼Œå¯¼è‡´ `previewImage` è™šæ‹Ÿå­—æ®µæœªé™„åŠ åˆ°è¿”å›å¯¹è±¡ã€‚

**å¤ç°è·¯å¾„**ï¼šåˆ—è¡¨æ¥å£ï¼ˆ`GET /api/sref`ï¼‰å·²åœ¨é˜¶æ®µ6ä¸­æ‰‹åŠ¨è¡¥å……äº† `previewImage`ï¼Œä½†è¯¦æƒ…æ¥å£çš„ related æŸ¥è¯¢å¿˜è®°åšç›¸åŒå¤„ç†ã€‚

### é—®é¢˜ 3 â€” å¡ç‰‡è¦†ç›–å±‚åœ¨å›¾ç‰‡åŠ è½½å‰è£¸éœ²

`/explore` ç€‘å¸ƒæµä¸­ï¼Œå›¾ç‰‡ä¸å›¾ç‰‡ä¹‹é—´å‡ºç° `--sref XXXXX`ã€å¤åˆ¶å›¾æ ‡ã€çœ¼ç›å›¾æ ‡ç­‰æ–‡å­—/å›¾æ ‡ï¼Œè§†è§‰ä¸Šéå¸¸å‡Œä¹±ã€‚

**æ ¹å› åˆ†æ**ï¼š

```
å›¾ç‰‡åŠ è½½å‰ï¼š
  img { opacity: 0 }          â† å›¾ç‰‡é€æ˜ï¼Œçœ‹ä¸è§
  .liblib-card-image é«˜åº¦ = 0  â† å®¹å™¨æ— é«˜åº¦ï¼ˆå›¾ç‰‡æœªæ’‘å¼€ï¼‰
  .liblib-style-tag å§‹ç»ˆåœ¨ DOM â† ç»å¯¹å®šä½ï¼Œç›¸å¯¹äºå®¹å™¨ top:0
  .liblib-card-overlay opacity:0 â† CSS æ§åˆ¶ hover æ‰æ˜¾ç¤º

ç»“æœï¼š
  æ‰€æœ‰å¡ç‰‡çš„ .liblib-card-image é«˜åº¦ä¸º 0ï¼Œå åœ¨ä¸€èµ·
  .liblib-style-tag çš„ç»å¯¹å®šä½ç›¸å¯¹äºé«˜åº¦ä¸º0çš„å®¹å™¨ï¼Œ
  å¤šä¸ªå¡ç‰‡çš„ badge æŒ¤åœ¨åŒä¸€ä½ç½®ï¼Œçœ‹èµ·æ¥åƒ"å›¾ç‰‡é—´çš„æ–‡å­—ä¹±ç "
```

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### Fix 1 â€” é¦–é¡µåˆ‡æ¢ä¸º srefAPI

**æ–‡ä»¶**ï¼š`client/src/pages/Home.js`

| æ”¹å‰ | æ”¹å |
|------|------|
| `import { enhancedPostAPI }` + `import { promptAPI }` | `import { srefAPI }` |
| `import LiblibStyleCard` + `import LiblibPromptCard` | `import SrefCard` |
| `fetchCombinedData`ï¼ˆå¹¶å‘è¯·æ±‚ä¸¤ä¸ª APIï¼Œåˆå¹¶æ’åºï¼‰ | `srefAPI.getPosts()` ç›´æ¥è°ƒç”¨ |
| `useInfiniteQuery` key: `homePosts` | key: `homeSrefs` |
| æ ‡ç­¾ï¼šä¸¤ä¸ª API æ ‡ç­¾åˆå¹¶å»é‡ | `srefAPI.getPopularTags(20)` |
| æ’åºé€‰é¡¹ï¼šæœ€æ–°/æœ€çƒ­/æœ€å¤šç‚¹èµ | æœ€æ–°/æœ€çƒ­ï¼ˆsref æ¥å£ä¸æ”¯æŒ likes æ’åºï¼‰ |
| æ¸²æŸ“ï¼š`contentType === 'prompt' ? <LiblibPromptCard> : <LiblibStyleCard>` | `<SrefCard sref={post} />` |
| æ— ç»“æœæ—¶ï¼šæ˜¾ç¤º"åˆ›å»ºé£æ ¼/åˆ›å»ºæç¤ºè¯"æŒ‰é’® | ç§»é™¤ï¼ˆsref æ˜¯çˆ¬å–æ•°æ®ï¼Œæ— ç”¨æˆ·åˆ›å»ºå…¥å£ï¼‰ |

**å…³é”®æ•°æ®æµå˜åŒ–**ï¼š

```javascript
// æ”¹å‰ï¼šå¹¶å‘ä¸¤ä¸ªAPI + å®¢æˆ·ç«¯æ’åº
const [postsResponse, promptsResponse] = await Promise.all([
  enhancedPostAPI.getPosts({ ... }),
  promptAPI.getPrompts({ ... })
]);
// åˆå¹¶ + sort by createdAt

// æ”¹åï¼šå•ä¸€APIç›´æ¥åˆ†é¡µ
srefAPI.getPosts({ page, limit: 24, sort, tags, search })
// æœåŠ¡ç«¯å·²æ’åº
```

**ç®€åŒ–æ•ˆæœ**ï¼šHome.js å‡å°‘çº¦ 75 è¡Œä»£ç ï¼Œé€»è¾‘æ¸…æ™°åº¦å¤§å¹…æå‡ã€‚

---

### Fix 2 â€” Related Styles previewImage è¡¥ä¸

**æ–‡ä»¶**ï¼š`server/routes/sref.js`ï¼Œè¯¦æƒ…æ¥å£ `GET /api/sref/:id`

åœ¨ related æŸ¥è¯¢ç»“æœè¿”å›å‰ï¼Œæ‰‹åŠ¨è¡¥å……è™šæ‹Ÿå­—æ®µï¼š

```javascript
// æ‰‹åŠ¨è¡¥å…… related çš„è™šæ‹Ÿå­—æ®µï¼ˆlean() ä¸ä¿è¯è™šæ‹Ÿå­—æ®µç”Ÿæ•ˆï¼‰
related.forEach(r => {
    if (!r.previewImage && r.images && r.images.length > 0) {
        r.previewImage = `/output/sref_${r.srefCode}/images/${r.images[0]}`;
    }
    if (r.likesCount === undefined) r.likesCount = 0;
});
```

ä¸åˆ—è¡¨æ¥å£ï¼ˆ`GET /api/sref`ï¼‰çš„å¤„ç†ä¿æŒå®Œå…¨ä¸€è‡´ã€‚

---

### Fix 3 â€” å¡ç‰‡è¦†ç›–å±‚åŠ è½½æ—¶æœºä¿®å¤

**åŒé‡ä¿®å¤ç­–ç•¥**ï¼š

#### 3a â€” CSS å ä½é«˜åº¦ï¼ˆå…œåº•ï¼‰

**æ–‡ä»¶**ï¼š`client/src/components/Post/LiblibStyleCard.css`

```css
/* æ”¹å‰ */
.liblib-card-image {
  position: relative;
  overflow: hidden;
  background: #0f172a;
}

/* æ”¹å */
.liblib-card-image {
  position: relative;
  overflow: hidden;
  background: #0f172a;
  min-height: 120px; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ï¼Œé˜²æ­¢ overlay/badge è£¸éœ² */
}
```

ä½œç”¨ï¼šç¡®ä¿å®¹å™¨æœ‰æœ€ä½é«˜åº¦ï¼Œç»å¯¹å®šä½å…ƒç´ ä¸ä¼šå› å®¹å™¨é«˜åº¦ä¸º 0 è€Œå †å åœ¨é¡¶éƒ¨ã€‚

#### 3b â€” JS æ§åˆ¶æ¸²æŸ“æ—¶æœºï¼ˆæ ¹æœ¬ä¿®å¤ï¼‰

**æ–‡ä»¶**ï¼š`client/src/components/Sref/SrefCard.js`

```jsx
// æ”¹å‰ï¼šbadge å’Œ overlay å§‹ç»ˆæ¸²æŸ“
<span className="liblib-style-tag">--sref {sref.srefCode}</span>
<div className="liblib-card-overlay">...</div>

// æ”¹åï¼šä»…åœ¨å›¾ç‰‡åŠ è½½å®Œæˆåæ¸²æŸ“
{imageLoaded && (
  <span className="liblib-style-tag">--sref {sref.srefCode}</span>
)}
{imageLoaded && (
  <div className="liblib-card-overlay">...</div>
)}
```

åˆ©ç”¨å·²æœ‰çš„ `imageLoaded` stateï¼ˆç”± `<img onLoad={handleImageLoad}>` è§¦å‘ï¼‰ï¼Œç¡®ä¿è¦†ç›–å±‚å…ƒç´ åªåœ¨å›¾ç‰‡çœŸæ­£æ¸²æŸ“åˆ°å±å¹•åæ‰åŠ å…¥ DOMï¼Œå½»åº•æœç»åŠ è½½æœŸé—´çš„è§†è§‰æ±¡æŸ“ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- `previewImage` å­˜åœ¨ â†’ ç­‰å¾… `onLoad` â†’ `imageLoaded = true` â†’ badge/overlay æ¸²æŸ“
- `previewImage` ä¸ºç©º â†’ æ˜¾ç¤º ğŸ¨ å ä½ â†’ `imageLoaded` æ°¸è¿œä¸º false â†’ badge/overlay ä¸æ¸²æŸ“ï¼ˆåˆç†ï¼Œå ä½å¡ç‰‡æ— éœ€æ˜¾ç¤ºæ“ä½œï¼‰

---

## ä¸‰ã€å—å½±å“æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `client/src/pages/Home.js` | é‡æ„ | åˆ‡æ¢æ•°æ®æºï¼Œåˆ é™¤ ~75 è¡Œä»£ç  |
| `server/routes/sref.js` | ä¿®å¤ | related æŸ¥è¯¢è¡¥å…… previewImage |
| `client/src/components/Sref/SrefCard.js` | ä¿®å¤ | badge/overlay æ¡ä»¶æ¸²æŸ“ |
| `client/src/components/Post/LiblibStyleCard.css` | ä¿®å¤ | å®¹å™¨æœ€å°é«˜åº¦å ä½ |

---

## å››ã€æŠ€æœ¯è¦ç‚¹

### mongoose lean() ä¸è™šæ‹Ÿå­—æ®µ

`lean()` è¿”å›çº¯ JavaScript å¯¹è±¡è€Œé Mongoose Document å®ä¾‹ï¼Œæ€§èƒ½æ›´å¥½ï¼Œä½†**é»˜è®¤ä¸åŒ…å«è™šæ‹Ÿå­—æ®µ**ã€‚è™½ç„¶ `lean({ virtuals: true })` å¯ä»¥å°è¯•é™„åŠ è™šæ‹Ÿå­—æ®µï¼Œä½†åœ¨æŸäº›ç‰ˆæœ¬çš„ mongoose ä¸‹å¯èƒ½ä¸ç¨³å®šã€‚

**æœ€ä½³å®è·µ**ï¼šå¯¹äºéœ€è¦åœ¨ `lean()` ç»“æœä¸­ä½¿ç”¨çš„è™šæ‹Ÿå­—æ®µï¼Œåœ¨è·¯ç”±å±‚æ‰‹åŠ¨è®¡ç®—å¹¶é™„åŠ ï¼Œä¸ä¾èµ– mongoose çš„è™šæ‹Ÿå­—æ®µæœºåˆ¶ï¼š

```javascript
// ä¸ä¾èµ–è™šæ‹Ÿå­—æ®µï¼Œæ‰‹åŠ¨æ„å»º URL
docs.forEach(doc => {
    doc.previewImage = doc.images?.[0]
        ? `/output/sref_${doc.srefCode}/images/${doc.images[0]}`
        : null;
});
```

### ç»å¯¹å®šä½å…ƒç´ ä¸é›¶é«˜åº¦å®¹å™¨

CSS ç»å¯¹å®šä½å…ƒç´ ç›¸å¯¹äºæœ€è¿‘çš„ `position: relative` ç¥–å…ˆå®šä½ã€‚å½“è¯¥ç¥–å…ˆå®¹å™¨é«˜åº¦ä¸º 0ï¼ˆå›¾ç‰‡å°šæœªåŠ è½½ï¼‰ï¼Œ`top: 0.45rem` çš„ç»å¯¹å®šä½ badge ä¼šå®šä½åœ¨å®¹å™¨é¡¶éƒ¨ï¼Œå¤šä¸ªé›¶é«˜åº¦å®¹å™¨å åŠ åï¼Œæ‰€æœ‰ badge æŒ¤åœ¨åŒä¸€å±å¹•ä½ç½®ï¼Œçœ‹èµ·æ¥åƒä¹±ç ã€‚

**è§£å†³ç­–ç•¥**ï¼š
1. ç»™å®¹å™¨è®¾ `min-height`ï¼ˆCSS å±‚é¢ï¼‰
2. å…ƒç´ æ¡ä»¶æ¸²æŸ“ï¼ˆJS å±‚é¢ï¼Œæ ¹æœ¬è§£å†³ï¼‰

ä¸¤è€…ç»“åˆæ•ˆæœæœ€ä½³ï¼šCSS `min-height` ä¿è¯å¸ƒå±€ç¨³å®šï¼ŒJS æ¡ä»¶æ¸²æŸ“ä¿è¯å…ƒç´ ä¸åœ¨æ— æ„ä¹‰æ—¶å‡ºç°ã€‚

---

## äº”ã€éªŒè¯

### æœåŠ¡ç«¯ï¼ˆéœ€é‡å¯åç”Ÿæ•ˆï¼‰
- `GET /api/sref/:id` â†’ `related[]` æ¯é¡¹åŒ…å« `previewImage` å­—æ®µ

### å®¢æˆ·ç«¯ï¼ˆçƒ­æ›´æ–°å³æ—¶ç”Ÿæ•ˆï¼‰
- é¦–é¡µ `/` â†’ æ˜¾ç¤º sref å¡ç‰‡ç€‘å¸ƒæµï¼Œæ ‡ç­¾æ¥è‡ª sref æ•°æ®
- `/explore` â†’ å›¾ç‰‡åŠ è½½å®Œæˆå‰ï¼Œæ—  `--sref` badge å’Œ overlay å…ƒç´ 
- `/explore/:id` Related Styles â†’ æ˜¾ç¤ºç¼©ç•¥å›¾

---

## å…­ã€åç»­å¾…åŠ

- [ ] æœåŠ¡å™¨é‡å¯éªŒè¯ related ç¼©ç•¥å›¾
- [ ] æµ‹è¯•é¦–é¡µæ ‡ç­¾ç­›é€‰ä¸æ’åºåŠŸèƒ½
- [ ] è€ƒè™‘ previewImage è®¡ç®—é€»è¾‘æå–ä¸ºå·¥å…·å‡½æ•°ï¼Œé¿å…åœ¨å¤šå¤„è·¯ç”±é‡å¤
