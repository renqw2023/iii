# ç”Ÿäº§ç¯å¢ƒé…ç½®é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜åˆ†æ

### å‘ç°çš„é—®é¢˜

1. **MongoDBé©±åŠ¨å¼ƒç”¨è­¦å‘Š**
   ```
   Warning: useNewUrlParser is a deprecated option
   Warning: useUnifiedTopology is a deprecated option
   ```

2. **é‚®ä»¶æœåŠ¡è¢«ç¦ç”¨**
   ```
   EMAIL_ENABLED: undefined
   SMTP_HOST: undefined
   SMTP_USER: undefined
   é‚®ä»¶æœåŠ¡: âŒ å·²ç¦ç”¨
   ```

3. **é‡å¤çš„dotenvé…ç½®åŠ è½½**
   - `server/index.js` ä¸­å­˜åœ¨ç‹¬ç«‹çš„ `require('dotenv').config()` è°ƒç”¨
   - å¯èƒ½è¦†ç›– `config` æ¨¡å—ä¸­æ­£ç¡®é…ç½®çš„ç¯å¢ƒå˜é‡åŠ è½½

### æ ¹æœ¬åŸå› 

1. **é…ç½®æ–‡ä»¶è·¯å¾„é”™è¯¯**: `server/config/index.js` ä¸­ dotenv åŠ è½½è·¯å¾„é…ç½®é”™è¯¯
2. **PM2ç¯å¢ƒå˜é‡ç¼ºå¤±**: `ecosystem.config.js` ä¸­ç¼ºå°‘é‚®ä»¶é…ç½®ç›¸å…³çš„ç¯å¢ƒå˜é‡
3. **MongoDBé©±åŠ¨ç‰ˆæœ¬å…¼å®¹æ€§**: ä½¿ç”¨äº†å·²å¼ƒç”¨çš„è¿æ¥é€‰é¡¹
4. **dotenvé‡å¤åŠ è½½**: `server/index.js` ä¸­çš„é‡å¤é…ç½®å¯èƒ½å¯¼è‡´ç¯å¢ƒå˜é‡åŠ è½½å†²çª

## âœ… ä¿®å¤å†…å®¹

### 1. ä¿®å¤dotenvé…ç½®æ–‡ä»¶è·¯å¾„

**æ–‡ä»¶**: `server/config/index.js`

```javascript
// ä¿®å¤å‰
require('dotenv').config();

// ä¿®å¤å
require('dotenv').config({ path: path.resolve(__dirname, '..', '.env') });
```

### 2. ç§»é™¤é‡å¤çš„dotenvåŠ è½½

**æ–‡ä»¶**: `server/index.js`

```javascript
// ä¿®å¤å‰
require('dotenv').config();
const express = require('express');
// ...
const config = require('./config');

// ä¿®å¤å
const express = require('express');
// ...
const config = require('./config'); // configæ¨¡å—å·²æ­£ç¡®åŠ è½½ç¯å¢ƒå˜é‡
```

### 3. ç§»é™¤MongoDBå¼ƒç”¨é€‰é¡¹

**æ–‡ä»¶**: `server/config/index.js`

```javascript
// æ•°æ®åº“é…ç½®
get database() {
  return {
    uri: process.env.MONGODB_URI || 'mongodb://localhost:27017/midjourney-gallery',
    options: {
      // MongoDB 4.0.0+ é©±åŠ¨å·²ç§»é™¤å¼ƒç”¨é€‰é¡¹
      maxPoolSize: parseInt(process.env.DB_MAX_POOL_SIZE) || 10,
      serverSelectionTimeoutMS: parseInt(process.env.DB_TIMEOUT) || 5000,
      socketTimeoutMS: parseInt(process.env.DB_SOCKET_TIMEOUT) || 45000,
      // æ·»åŠ å…¶ä»–æ¨èçš„è¿æ¥é€‰é¡¹
      maxIdleTimeMS: parseInt(process.env.DB_MAX_IDLE_TIME) || 30000,
      connectTimeoutMS: parseInt(process.env.DB_CONNECT_TIMEOUT) || 10000,
    },
  };
}
```

### 4. ä¿®å¤è„šæœ¬æ–‡ä»¶ä¸­çš„MongoDBè¿æ¥

**ä¿®å¤çš„æ–‡ä»¶**:
- `server/scripts/promoteUser.js`
- `server/scripts/testConnection.js`
- `server/scripts/createSampleData.js`
- `server/scripts/seedData.js`
- `server/scripts/importData.js`
- `server/scripts/createAdmin.js`

**ä¿®å¤å†…å®¹**:
```javascript
// ä¿®å¤å‰
require('dotenv').config();
await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/midjourney-gallery');

// ä¿®å¤å
const config = require('../config');
await mongoose.connect(config.database.uri, config.database.options);
```
```

### 5. æ›´æ–°PM2é…ç½®

**æ–‡ä»¶**: `ecosystem.config.js`

æ·»åŠ äº†å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®ï¼š
- é‚®ä»¶æœåŠ¡é…ç½® (EMAIL_ENABLED, SMTP_*)
- å®¢æˆ·ç«¯URLé…ç½®
- æ–‡ä»¶ä¸Šä¼ é…ç½®
- æ•°æ®åº“å’ŒJWTé…ç½®

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä¸€é”®ä¿®å¤ï¼ˆæ¨èï¼‰

```bash
cd /var/www/mj-gallery
git pull origin main  # æˆ–è€…æ‰‹åŠ¨ä¸Šä¼ ä¿®å¤åçš„æ–‡ä»¶

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x quick-fix-all-issues.sh

# è¿è¡Œä¸€é”®ä¿®å¤è„šæœ¬
./quick-fix-all-issues.sh
```

### æ–¹æ³•äºŒï¼šåˆ†æ­¥éª¤ä¿®å¤

1. **æ›´æ–°ä»£ç **
   ```bash
   cd /var/www/mj-gallery
   git pull origin main  # æˆ–è€…æ‰‹åŠ¨ä¸Šä¼ ä¿®å¤åçš„æ–‡ä»¶
   ```

2. **è¿è¡Œdotenvå†²çªä¿®å¤è„šæœ¬**
   ```bash
   # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
   chmod +x fix-dotenv-conflict.sh
   
   # è¿è¡Œä¿®å¤è„šæœ¬
   ./fix-dotenv-conflict.sh
   ```

3. **è®¾ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # æ–¹æ³•1: ä½¿ç”¨æä¾›çš„è„šæœ¬
   chmod +x setup-production-env.sh
   source setup-production-env.sh
   
   # æ–¹æ³•2: æ‰‹åŠ¨è®¾ç½®
   export EMAIL_ENABLED="true"
   export SMTP_HOST="smtpdm.aliyun.com"
   export SMTP_PORT="465"
   export SMTP_SECURE="true"
   export SMTP_USER="i@mail.iii.pics"
   export SMTP_PASS="MJcoolai123"
   export EMAIL_FROM_NAME="MJ Gallery"
   export EMAIL_FROM_ADDRESS="i@mail.iii.pics"
   ```

4. **æœ€ç»ˆé‡å¯PM2æœåŠ¡**
   ```bash
   pm2 restart mj-gallery-server
   ```

5. **éªŒè¯ä¿®å¤**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   pm2 status
   
   # æŸ¥çœ‹æ—¥å¿—
   pm2 logs mj-gallery-server --lines 20
   
   # éªŒè¯é…ç½®
   cd /var/www/mj-gallery
   node server/scripts/validateConfig.js
   ```

## ğŸ“‹ éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ­£å¸¸è¾“å‡ºï¼š

- âœ… æ²¡æœ‰MongoDBé©±åŠ¨å¼ƒç”¨è­¦å‘Š
- âœ… é‚®ä»¶æœåŠ¡æ˜¾ç¤ºä¸º"å·²å¯ç”¨"
- âœ… SMTPé…ç½®ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
- âœ… æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨åœ¨ç«¯å£5500

### é¢„æœŸçš„æ­£å¸¸æ—¥å¿—è¾“å‡ºï¼š

```
====== ç¯å¢ƒå˜é‡åŠ è½½ ======
NODE_ENV: production
EMAIL_ENABLED: true
SMTP_HOST: smtpdm.aliyun.com
SMTP_USER: i@mail.iii.pics
=========================
====== é…ç½®æ‘˜è¦ ======
ç¯å¢ƒ: production
ç«¯å£: 5500
æ•°æ®åº“: mongodb://localhost:27017/midjourney-gallery
é‚®ä»¶æœåŠ¡: âœ… å·²å¯ç”¨
SMTPä¸»æœº: smtpdm.aliyun.com
å‘ä»¶äºº: i@mail.iii.pics
======================
âœ… é…ç½®éªŒè¯é€šè¿‡
é‚®ä»¶æœåŠ¡å·²åˆå§‹åŒ–
âœ… MongoDBè¿æ¥æˆåŠŸ
ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:5500
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœé‚®ä»¶æœåŠ¡ä»ç„¶è¢«ç¦ç”¨ï¼š

1. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   echo $EMAIL_ENABLED
   echo $SMTP_HOST
   echo $SMTP_USER
   ```

2. **æ£€æŸ¥PM2ç¯å¢ƒå˜é‡**
   ```bash
   pm2 show mj-gallery-server
   ```

3. **é‡æ–°åŠ è½½PM2é…ç½®**
   ```bash
   pm2 delete mj-gallery-server
   pm2 start ecosystem.config.js
   ```

### å¦‚æœä»æœ‰MongoDBè­¦å‘Šï¼š

1. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†å¼ƒç”¨é€‰é¡¹
2. ç¡®è®¤MongoDBé©±åŠ¨ç‰ˆæœ¬
3. é‡å¯æœåŠ¡ç¡®ä¿æ–°é…ç½®ç”Ÿæ•ˆ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•æ„Ÿä¿¡æ¯å®‰å…¨**: ç¡®ä¿SMTPå¯†ç ç­‰æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨æ€§
2. **ç¯å¢ƒå˜é‡æŒä¹…åŒ–**: è€ƒè™‘å°†ç¯å¢ƒå˜é‡æ·»åŠ åˆ°ç³»ç»Ÿé…ç½®æ–‡ä»¶ä¸­
3. **ç›‘æ§**: éƒ¨ç½²åæŒç»­ç›‘æ§æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—
4. **å¤‡ä»½**: åœ¨ä¿®æ”¹å‰å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶

## ğŸ“Š ä¿®å¤æ•ˆæœ

- âœ… æ¶ˆé™¤äº†MongoDBé©±åŠ¨å¼ƒç”¨è­¦å‘Š
- âœ… æ¢å¤äº†é‚®ä»¶æœåŠ¡åŠŸèƒ½
- âœ… è§£å†³äº†dotenvé…ç½®å†²çªé—®é¢˜
- âœ… æ”¹å–„äº†é…ç½®ç®¡ç†çš„å¯é æ€§
- âœ… æä¾›äº†å®Œæ•´çš„éƒ¨ç½²è„šæœ¬å’Œæ–‡æ¡£

---

**ä¿®å¤æ—¶é—´**: 2025-01-24  
**æœ€æ–°æ›´æ–°**: 2025-01-24 - å‘ç°å¹¶ä¿®å¤dotenvé…ç½®å†²çªé—®é¢˜  
**çŠ¶æ€**: å·²å®Œæˆæ‰€æœ‰ä¿®å¤ï¼ŒåŒ…æ‹¬dotenvå†²çªé—®é¢˜ï¼Œå¾…æœåŠ¡å™¨éƒ¨ç½²éªŒè¯  
**ä¸‹æ¬¡æ›´æ–°**: æœåŠ¡å™¨éƒ¨ç½²éªŒè¯å®Œæˆåæ›´æ–°çŠ¶æ€

## ğŸ†• æœ€æ–°å‘ç°å’Œä¿®å¤

### é—®é¢˜æ ¹å› åˆ†æ
é€šè¿‡åˆ†ææœåŠ¡å™¨æ—¥å¿—å‘ç°ï¼Œå°½ç®¡å·²ç»ä¿®å¤äº†MongoDBè¿æ¥é…ç½®å’Œè„šæœ¬æ–‡ä»¶ï¼Œä½†MongoDBå¼ƒç”¨è­¦å‘Šä»ç„¶å­˜åœ¨ã€‚è¿›ä¸€æ­¥æ£€æŸ¥å‘ç°ï¼š

1. **server/index.js** ä¸­å­˜åœ¨ç‹¬ç«‹çš„ `require('dotenv').config()` è°ƒç”¨
2. è¿™ä¸ªè°ƒç”¨åœ¨ `config` æ¨¡å—åŠ è½½ä¹‹å‰æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´ç¯å¢ƒå˜é‡åŠ è½½å†²çª
3. ç”±äºæ²¡æœ‰æŒ‡å®šæ­£ç¡®çš„è·¯å¾„ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®åŠ è½½ `.env` æ–‡ä»¶

### ä¿®å¤æ–¹æ¡ˆ
1. ç§»é™¤ `server/index.js` ä¸­é‡å¤çš„ dotenv é…ç½®
2. ç¡®ä¿åªé€šè¿‡ `config` æ¨¡å—ç»Ÿä¸€ç®¡ç†ç¯å¢ƒå˜é‡åŠ è½½
3. æä¾›ä¸“é—¨çš„ä¿®å¤è„šæœ¬ `fix-dotenv-conflict.sh` å’Œ `fix-dotenv-conflict.bat`

### é¢„æœŸæ•ˆæœ
ä¿®å¤ååº”è¯¥å®Œå…¨æ¶ˆé™¤MongoDBå¼ƒç”¨è­¦å‘Šï¼Œå› ä¸ºï¼š
- æ‰€æœ‰æ•°æ®åº“è¿æ¥éƒ½ä½¿ç”¨ç»Ÿä¸€çš„ `config.database.options`
- ç¯å¢ƒå˜é‡åŠ è½½è·¯å¾„æ­£ç¡®
- æ²¡æœ‰é…ç½®å†²çª