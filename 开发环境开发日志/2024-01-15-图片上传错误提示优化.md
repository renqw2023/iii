# 图片上传错误提示优化开发日志

## 修改时间
2024-01-15

## 问题描述
在提示词创建页面，当用户上传文件超出限制时（如超过文件数量或大小限制），页面显示500服务器错误，对普通用户不友好，用户无法理解具体的错误原因。

## 解决方案

### 1. 前端优化

#### 文件：`client/src/pages/CreatePrompt.js`

**增加前端验证：**
- 在提交前验证文件数量（最多9张）
- 在提交前验证文件大小（最大20MB）
- 提供具体的错误提示信息

**优化错误处理：**
- 针对400状态码：显示服务器返回的具体错误信息
- 针对413状态码：文件大小超过限制提示
- 针对500状态码：服务器错误提示
- 网络错误：连接失败提示

**改进拖拽区域提示：**
- 在上传区域添加明确的限制说明
- 显示当前已上传文件数量
- 列出支持的文件格式

**优化onDropRejected回调：**
- `too-many-files`：文件数量超限提示
- `file-too-large`：文件过大提示
- `file-invalid-type`：文件类型无效提示

### 2. 后端优化

#### 文件：`server/routes/upload.js`

**改进错误处理中间件：**
- `LIMIT_FILE_SIZE`："文件大小超过限制，单个文件最大20MB"
- `LIMIT_FILE_COUNT`："文件数量超过限制，最多上传9个文件"
- `LIMIT_UNEXPECTED_FILE`："上传的文件字段不正确"
- 文件格式错误："不支持的文件格式，请选择图片或视频文件"
- 通用错误："文件上传失败，请稍后重试"

#### 文件：`server/routes/prompts.js`

**添加错误处理中间件：**
- 与upload.js保持一致的错误处理逻辑
- 确保multer错误能被正确捕获和处理
- 返回400状态码而不是500，提供具体错误信息

## 技术实现

### 前端验证逻辑
```javascript
// 文件数量验证
if (files.length > 9) {
  setError('最多只能上传9张图片或视频');
  return;
}

// 文件大小验证
const oversizedFiles = files.filter(file => file.size > 20 * 1024 * 1024);
if (oversizedFiles.length > 0) {
  setError('文件大小不能超过20MB');
  return;
}
```

### 后端错误处理
```javascript
router.use((error, req, res, next) => {
  if (error instanceof multer.MulterError) {
    // 根据错误类型返回具体的错误信息
    // 使用400状态码而不是500
  }
});
```

## 用户体验改进

1. **明确的限制说明**：在上传区域显示"最多上传9张图片或视频，单个文件最大20MB"
2. **实时反馈**：显示当前已上传文件数量
3. **具体错误提示**：不再显示500错误，而是具体的错误原因
4. **前端预验证**：在提交前就进行验证，减少不必要的网络请求
5. **友好的错误信息**：使用用户能理解的语言描述错误

## 影响范围

- **前端**：提示词创建页面的用户体验
- **后端**：文件上传相关的错误处理
- **用户**：更好的错误提示和操作指导

## 测试建议

1. 测试上传超过9张图片
2. 测试上传超过20MB的文件
3. 测试上传不支持的文件格式
4. 测试网络异常情况
5. 验证错误提示信息的准确性和友好性

## 注意事项

- 前后端限制保持一致（9张图片，20MB大小）
- 错误状态码使用400而不是500
- 错误信息要对用户友好
- 保持国际化支持的一致性